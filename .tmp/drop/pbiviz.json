{"visual":{"name":"powerBI-Visuals-funnel","displayName":"Funnel plot","guid":"RHTML_FUNNEL_978302916642","visualClassName":"Visual","version":"1.0.0","description":"","supportUrl":"http://community.powerbi.com/","gitHubUrl":"https://github.com/Microsoft/powerbi-visuals-funnel"},"apiVersion":"1.6.0","author":{"name":"Microsoft","email":"pbicvsupport@microsoft.com"},"assets":{"icon":"assets/icon.png"},"externalJS":[],"style":"style/visual.less","capabilities":{"dataRoles":[{"displayName":"Population","description":"Numeric variable (positive integer)","kind":"GroupingOrMeasure","name":"population"},{"displayName":"Occurrence","description":"Numeric variable (nonnegative integer). Must be smaller than Population","kind":"GroupingOrMeasure","name":"occurrence"},{"displayName":"Tooltips","description":"Fields to be used as hover tooltips","kind":"Grouping","name":"tooltips"}],"dataViewMappings":[{"conditions":[{"population":{"max":1},"occurrence":{"max":1},"tooltips":{"max":7}}],"scriptResult":{"dataInput":{"table":{"rows":{"select":[{"for":{"in":"population"}},{"for":{"in":"occurrence"}},{"for":{"in":"tooltips"}}],"dataReductionAlgorithm":{"top":{}}}}},"script":{"scriptProviderDefault":"R","scriptOutputType":"html","source":{"objectName":"rcv_script","propertyName":"source"},"provider":{"objectName":"rcv_script","propertyName":"provider"},"scriptSourceDefault":"# Copyright (c) Microsoft Corporation.  All rights reserved.\r\n\r\n# Third Party Programs. This software enables you to obtain software applications from other sources. \r\n# Those applications are offered and distributed by third parties under their own license terms.\r\n# Microsoft is not developing, distributing or licensing those applications to you, but instead, \r\n# as a convenience, enables you to use this software to obtain those applications directly from \r\n# the application providers.\r\n# By using the software, you acknowledge and agree that you are obtaining the applications directly\r\n# from the third party providers and under separate license terms, and that it is your responsibility to locate, \r\n# understand and comply with those license terms.\r\n# Microsoft grants you no license rights for third-party software or applications that is obtained using this software.\r\n\r\n# See also:\r\n# http://stats.stackexchange.com/questions/5195/how-to-draw-funnel-plot-using-ggplot2-in-r/5210#5210\r\n\r\n\r\n#DEBUG in RStudio\r\n# fileRda = \"C:/Users/boefraty/projects/PBI/R/tempData.Rda\"\r\n# if(file.exists(dirname(fileRda)))\r\n# {\r\n#   if(Sys.getenv(\"RSTUDIO\")!=\"\")\r\n#     load(file= fileRda)\r\n#   else\r\n#     save(list = ls(all.names = TRUE), file=fileRda)\r\n# }\r\n\r\n\r\n############ User Parameters #########\r\n# Set of parameters from GUI\r\n\r\n##PBI_PARAM Color of scatterplot points\r\n#Type:string, Default:\"orange\", Range:NA, PossibleValues:\"orange\",\"blue\",\"green\",\"black\"\r\npointsCol = \"orange\"\r\nif(exists(\"settings_scatter_params_pointColor\")){\r\n  pointsCol = settings_scatter_params_pointColor\r\n}\r\n\r\n#PBI_PARAM Transparency of scatterplot points\r\n#Type:numeric, Default:0.4, Range:[0,1], PossibleValues:NA, Remarks: NA\r\ntransparency = 0.4\r\nif(exists(\"settings_scatter_params_percentile\")){\r\n  transparency = settings_scatter_params_percentile/100\r\n}\r\n\r\n##PBI_PARAM Color of baseline\r\n#Type:string, Default:\"blue\", Range:NA, PossibleValues:\"orange\",\"blue\",\"green\",\"black\"\r\nlineColor = \"blue\"\r\nif(exists(\"settings_funnel_params_lineColor\")){\r\n  lineColor = settings_funnel_params_lineColor\r\n}\r\n\r\n\r\n#PBI_PARAM Sparsification of scatterplot points\r\n#Type:bool, Default:TRUE, Range:NA, PossibleValues:NA, Remarks: NA\r\nsparsify = TRUE\r\nif(exists(\"settings_scatter_params_sparsify\")){\r\n  sparsify = settings_scatter_params_sparsify\r\n}\r\n\r\n#PBI_PARAM Size of points on the plot\r\n#Type:numeric, Default: 1 , Range:[0.1,5], PossibleValues:NA, Remarks: NA\r\npointCex = 1\r\nif(exists(\"settings_scatter_params_weight\")){\r\n  pointCex = min(50,max(settings_scatter_params_weight,1))/10\r\n}\r\n\r\n\r\n#PBI_PARAM Confidence level line\r\n#Type:numeric, Default: 0.75 , Range:[0,1], PossibleValues:NA, Remarks: GUI input is predefined set of values\r\nconf1 = 0.95\r\nif(exists(\"settings_funnel_params_conf1\")){\r\n  conf1 = as.numeric(settings_funnel_params_conf1)\r\n}\r\n\r\n#PBI_PARAM Confidence level line #2\r\n#Type:numeric, Default: 0.95 , Range:[0,1], PossibleValues:NA, Remarks: NA\r\nconf2 = 0.99\r\nif(exists(\"settings_funnel_params_conf2\")){\r\n  conf2 = as.numeric(settings_funnel_params_conf2)\r\n}\r\n\r\n\r\naxisXisPercentage = TRUE # ratio or percentage \r\nif(exists(\"settings_axes_params_axisXisPercentage\")){\r\n  axisXisPercentage = as.numeric(settings_axes_params_axisXisPercentage)\r\n}\r\n\r\nscaleXformat = \"comma\"\r\nif(exists(\"settings_axes_params_scaleXformat\")){\r\n  scaleXformat = settings_axes_params_scaleXformat\r\n}\r\n\r\nscaleYformat = \"none\"\r\nif(exists(\"settings_axes_params_scaleYformat\")){\r\n  scaleYformat = settings_axes_params_scaleYformat\r\n}\r\n\r\n#PBI_PARAM Size of labels on axes\r\nsizeLabel = 12\r\nif(exists(\"settings_axes_params_textSize\")){\r\n  sizeLabel = settings_axes_params_textSize\r\n}\r\n\r\n#PBI_PARAM Size of ticks on axes \r\nsizeTicks = 6\r\nif(exists(\"settings_axes_params_sizeTicks\")){\r\n  sizeTicks = as.numeric(settings_axes_params_sizeTicks)\r\n}\r\n#PBI_PARAM Size of labels on axes\r\ncolLabel = \"gray\"\r\nif(exists(\"settings_axes_params_colLabel\")){\r\n  colLabel = settings_axes_params_colLabel\r\n}\r\n###############Library Declarations###############\r\n\r\n############### Flattening HTML functions ###############\r\nlibraryRequireInstall = function(packageName, ...)\r\n{\r\n  if(!require(packageName, character.only = TRUE)) \r\n    warning(paste(\"*** The package: '\", packageName, \"' was not installed ***\", sep=\"\"))\r\n}\r\n\r\nlibraryRequireInstall(\"XML\")\r\nlibraryRequireInstall(\"htmlwidgets\")\r\n\r\ninternalSaveWidget <- function(widget, fname)\r\n{\r\n  tempFname = paste(fname, \".tmp\", sep=\"\")\r\n  htmlwidgets::saveWidget(widget, file = tempFname, selfcontained = FALSE)\r\n  FlattenHTML(tempFname, fname)\r\n}\r\n\r\nFlattenHTML <- function(fnameIn, fnameOut)\r\n{\r\n  # Read and parse HTML file\r\n  # Embed all js and css files into one unified file\r\n  \r\n  if(!file.exists(fnameIn))\r\n    return(FALSE)\r\n  \r\n  dir = dirname(fnameIn)\r\n  html = htmlTreeParse(fnameIn, useInternal = TRUE)\r\n  top = xmlRoot(html)\r\n  \r\n  # extract all <script> tags with src value\r\n  srcNode=getNodeSet(top, '//script[@src]')\r\n  for (node in srcNode)\r\n  {\r\n    b = xmlAttrs(node)\r\n    fname = file.path(dir, b['src'])\r\n    alternateSrc = FindSrcReplacement(fname)\r\n    if (!is.null(alternateSrc))\r\n    {\r\n      s = alternateSrc\r\n      names(s) = 'src'\r\n      newNode = xmlNode(\"script\",attrs = s)\r\n      replaceNodes(node, newNode)\r\n    }else{\r\n      str=ReadFileForEmbedding(fname);\r\n      if (!is.null(str))\r\n      {      \r\n        newNode = xmlNode(\"script\", str, attrs = c(type = \"text/javascript\"))\r\n        replaceNodes(node, newNode)\r\n      }\r\n    }\r\n  }\r\n  \r\n  # extract all <link> tags with src value\r\n  linkNode=getNodeSet(top, '//link[@href]')\r\n  for (node in linkNode)\r\n  {\r\n    b = xmlAttrs(node)\r\n    fname = file.path(dir, b['href'])\r\n    str = ReadFileForEmbedding(fname, FALSE);\r\n    if (!is.null(str))\r\n    {\r\n      newNode = xmlNode(\"style\", str)\r\n      replaceNodes(node, newNode)\r\n    }\r\n  }\r\n  \r\n  saveXML(html, file = fnameOut)\r\n  return(TRUE)\r\n}\r\n\r\nReadFileForEmbedding <- function(fname, addCdata = TRUE)\r\n{\r\n  data = ReadFullFile(fname)\r\n  if (is.null(data))\r\n    return(NULL)\r\n\r\n  str = paste(data, collapse ='\\n')\r\n  if (addCdata) {\r\n    str = paste(cbind('// <![CDATA[', str,'// ]]>'), collapse ='\\n')\r\n  }\r\n  return(str)\r\n}\r\n\r\nReadFullFile <- function(fname)\r\n{\r\n  if(!file.exists(fname))\r\n    return(NULL)\r\n  \r\n  con = file(fname, open = \"r\")\r\n  data = readLines(con)\r\n  close(con)\r\n  return(data)\r\n}\r\n\r\nFindSrcReplacement <- function(str)\r\n{\r\n  # finds reference to 'plotly' js and replaces with a version from CDN\r\n  # This allows the HTML to be smaller, since this script is not fully embedded in it\r\n  str <- iconv(str, to=\"UTF-8\")\r\n  pattern = \"plotlyjs-(\\\\w.+)/plotly-latest.min.js\"\r\n  match1=regexpr(pattern, str)\r\n  attr(match1, 'useBytes') <- FALSE\r\n  strMatch=regmatches(str, match1, invert = FALSE)\r\n  if (length(strMatch) == 0) return(NULL)\r\n  \r\n  pattern2 = \"-(\\\\d.+)/\"\r\n  match2 = regexpr(pattern2, strMatch[1])\r\n  attr(match2, 'useBytes') <- FALSE\r\n  strmatch = regmatches(strMatch[1], match2)\r\n  if (length(strmatch) == 0) return(NULL)\r\n  \r\n  # CDN url is https://cdn.plot.ly/plotly-<Version>.js\r\n  # This matches the specific version used in the plotly package used.\r\n  verstr = substr(strmatch, 2, nchar(strmatch)-1)\r\n  str = paste('https://cdn.plot.ly/plotly-', verstr,'.min.js', sep='')\r\n  return(str)\r\n}\r\n#################################################\r\n\r\n\r\n#utils.r file with small general functions \r\n\r\nlibraryRequireInstall = function(packageName, ...)\r\n{\r\n  if(!require(packageName, character.only = TRUE)) \r\n    warning(paste(\"*** The package: '\", packageName, \"' was not installed ***\", sep=\"\"))\r\n}\r\n\r\n# Ecamone text string \r\n# if very very long abbreviate\r\n# if looooooong convert to lo...\r\n# if shorter than maxChar remove \r\ncutStr2Show = function(strText, strCex = 0.8, abbrTo = 100, isH = TRUE, maxChar = 3, partAvailable = 1)\r\n{\r\n  # partAvailable, wich portion of window is available, in [0,1]\r\n  if(is.null(strText))\r\n    return (NULL)\r\n  \r\n  SCL = 0.075*strCex/0.8\r\n  pardin = par()$din\r\n  gStand = partAvailable*(isH*pardin[1]+(1-isH)*pardin[2]) /SCL\r\n  \r\n  # if very very long abbreviate\r\n  if(nchar(strText)>abbrTo && nchar(strText)> 1)\r\n    strText = abbreviate(strText, abbrTo)\r\n  \r\n  # if looooooong convert to lo...\r\n  if(nchar(strText)>round(gStand) && nchar(strText)> 1)\r\n    strText = paste(substring(strText,1,floor(gStand)),\"...\",sep=\"\")\r\n  \r\n  # if shorter than maxChar remove \r\n  if(gStand<=maxChar)\r\n    strText = NULL\r\n  \r\n  return(strText) \r\n}\r\n\r\n#if it attributeColumn is legal colors() use them \r\n#if all the entries in attributeColumn are the same number - use defaultColor\r\n#if it has many numeric variables color from green to red range \r\n#if it has few unique strings - use rainbow to color them \r\nColorPerPoint = function (attributeColumn, defaultColor = pointsCol, sizeColRange = 30)\r\n{\r\n  N = length(attributeColumn)\r\n  if(sum(attributeColumn %in% colors()) == N) # all legal colors\r\n    return(attributeColumn)\r\n  \r\n  UN = length(unique(attributeColumn))\r\n  if(UN == 1) # single number \r\n    return(defaultColor)\r\n  \r\n  sortedUniqueValues = sort(unique(attributeColumn))\r\n  \r\n  if((UN > sizeColRange*3) || (UN >= N - 2 && is.numeric(attributeColumn))) # many numbers --> color range \r\n  {\r\n    rangeColors = terrain.colors(sizeColRange)# 30 colors\r\n    if(is.numeric(attributeColumn))\r\n    {\r\n      breaks = seq(min(sortedUniqueValues), max(sortedUniqueValues),length.out = sizeColRange + 1)\r\n      pointsCol = as.character(cut(attributeColumn, breaks,labels = rangeColors))\r\n      return(pointsCol)\r\n    }\r\n    else\r\n    {# spread colors\r\n      outCol = rep(rangeColors, each = ceiling(N/sizeColRange), length.out = N)\r\n      return(outCol)\r\n    }\r\n  } else {\r\n    rangeColors = rainbow(UN)\r\n    names(rangeColors) = sortedUniqueValues\r\n    return(rangeColors[as.character(attributeColumn)])\r\n  }\r\n}\r\n\r\n\r\n#randomly remove points from scatter if too many \r\nSparsifyScatter = function (xyDataFrame, numXstrips = 9, numYstrips = 7, minMaxPoints = c(3000,9000), minmaxInStrip =  c(900,9000), maxInCell = 300, remDuplicated = TRUE)\r\n{\r\n  \r\n  N_big = N = nrow(xyDataFrame)\r\n  usePoints = rep(TRUE,N)\r\n  \r\n  if(N <= minMaxPoints[1]) # do nothing\r\n    return (usePoints)\r\n  \r\n  if(remDuplicated) # remove duplicated\r\n  {\r\n    usePoints = usePoints & (!duplicated(xyDataFrame))\r\n    N = sum(usePoints)\r\n  }\r\n  \r\n  if(N <= minMaxPoints[1]) # do nothing\r\n    return (usePoints)\r\n  \r\n  rangeX = range(xyDataFrame[,1])\r\n  rangeY = range(xyDataFrame[,2])\r\n  \r\n  gridX = seq(rangeX[1],rangeX[2], length.out = numXstrips + 1)\r\n  gridY = seq(rangeY[1],rangeY[2], length.out = numYstrips + 1)\r\n  \r\n  #go cell by cell and sparsify \r\n  for (iX in seq(1,numXstrips))\r\n  {\r\n    smallRangeX = c(gridX[iX],gridX[iX+1])\r\n    inStrip = xyDataFrame[,1]>= smallRangeX[1] & xyDataFrame[,1]<= smallRangeX[2] &  usePoints\r\n    if(sum(inStrip) > minmaxInStrip[1])\r\n      for (iY in seq(1,numYstrips))\r\n      {\r\n        smallRangeY = c(gridY[iY],gridY[iY+1])\r\n        inCell = xyDataFrame[,2]>= smallRangeY[1] & xyDataFrame[,2]<= smallRangeY[2] &  inStrip\r\n        if(sum(inCell) > maxInCell)\r\n        {\r\n          inCellIndexes = seq(1,N_big)[inCell]\r\n          #randomly select maxInCell out of inCellIndexes\r\n          iii = sample(inCellIndexes,size = sum(inCell) - maxInCell, replace = FALSE)\r\n          usePoints[iii] = FALSE\r\n        }\r\n      }\r\n    \r\n  }\r\n  N = sum(usePoints)\r\n  \r\n  #if by the end still too many points --> go on whole set  \r\n  if(N > minMaxPoints[2])\r\n  {\r\n    inIndexes = seq(1,N_big)[usePoints]\r\n    #randomly select minMaxPoints[2] out of inIndexes\r\n    iii = sample(inIndexes,size = minMaxPoints[2], replace = FALSE)\r\n    usePoints[-iii] = FALSE\r\n    \r\n  }\r\n  return (usePoints)\r\n}\r\n\r\n# return FALSE if canvas is too small\r\ngoodPlotDimension = function(minWidthInch = 3,minHeightInch = 2.2)\r\n{\r\n  re = (par()$din[1] > minWidthInch) & (par()$din[2] > minHeightInch)\r\n  return(re)\r\n}\r\n\r\n\r\n\r\nlibraryRequireInstall(\"ggplot2\")\r\nlibraryRequireInstall(\"plotly\")\r\nlibraryRequireInstall(\"scales\")\r\n\r\n\r\n###############Internal parameters definitions#################\r\n# Set of parameters, which are not exported to GUI\r\n\r\n#PBI_PARAM is vertical plot\r\nverticalPlot = FALSE\r\n\r\n#PBI_PARAM Minimal number of points for funnel plot\r\nminPoints = 10\r\n\r\n#PBI_PARAM Size of warnings font\r\nsizeWarn = 11\r\n\r\n\r\n###############Internal functions definitions#################\r\n\r\n#paste tooltips together separated by <br>\r\ngenerateNiceTooltips = function(dataset)\r\n{\r\n  myNames = names(dataset)\r\n  LMN = length(myNames)\r\n  s = 1; if(LMN > 2)  s = 3\r\n  \r\n  nms = myNames[s:LMN]\r\n  dta = dataset[,s:LMN]\r\n  niceTooltips = NULL\r\n  \r\n  for (n in c(1:length(nms)))\r\n  {\r\n    if(length(nms) == 1)\r\n      niceTooltips = paste(nms,\" = \", dta, sep = \"\") \r\n    else\r\n    {\r\n      niceTooltips = paste(niceTooltips,nms[n],\" = \", dta[,n], sep = \"\")  \r\n      if(n < length(nms))\r\n        niceTooltips = paste(niceTooltips,\"<br>\", sep = \"\")\r\n    }\r\n  }\r\n  return(niceTooltips)\r\n}\r\n\r\n#tweak the limits of the axis\r\nNiceLimitsAxis <- function(axisData, baseline =NULL, isPositive = TRUE)\r\n{\r\nlimsA = c(min(axisData), max(axisData)) # default\r\nif(is.null(baseline))\r\n  baseline = sum(limsA)/2\r\n\r\nlimsA = (limsA - mean(limsA)) * 1.3 + baseline # centralize\r\nlimsA[1] = min(limsA[1], min(axisData)) # include outliers\r\nlimsA[2] = max(limsA[2], max(axisData)) # include outliers\r\nif(limsA[1] < 0 && isPositive) # don't include region far away from 0\r\n{ \r\n  temp = -0.02 * (limsA[2])\r\n  limsA[1] = max(temp, limsA[1]) \r\n}\r\nreturn(limsA)\r\n}\r\n############# Input validation & initializations ############# \r\n\r\nif(conf2 < conf1)# swap\r\n{   temp = conf1; conf1 = conf2; conf2 = temp}\r\n\r\nvalidToPlot = TRUE\r\n\r\npbiWarning = \"\"\r\n\r\ngpd = goodPlotDimension()\r\n\r\n\r\nif(validToPlot && !gpd) # too small canvas\r\n{\r\n  validToPlot = FALSE\r\n  pbiWarning1 = \"Visual is \"\r\n  pbiWarning1 = cutStr2Show(pbiWarning1, strCex = sizeWarn/6, partAvailable = 0.9)\r\n  pbiWarning2 = \"too small \"\r\n  pbiWarning2 = cutStr2Show(pbiWarning2, strCex = sizeWarn/6, partAvailable = 0.9)\r\n  pbiWarning<-paste(pbiWarning1, \"<br>\", pbiWarning2, sep=\"\")\r\n  sizeWarn = 8 #smaller \r\n}\r\n\r\nif(validToPlot && (!exists(\"population\") ||!exists(\"occurrence\"))) # invalid input \r\n{\r\n  validToPlot = FALSE\r\n  pbiWarning1 = \"Both population and occurrence are required\"\r\n  pbiWarning = cutStr2Show(pbiWarning1, strCex = sizeWarn/6, partAvailable = 0.9)\r\n}\r\n\r\nif(validToPlot)\r\n{\r\n  population[is.na(population)] = 0\r\n  occurrence[is.na(occurrence)] = -1\r\n  population[is.null(population)] = 0\r\n  occurrence[is.null(occurrence)] = -1\r\n  \r\n  #clean data\r\n  validData = rep(TRUE,nrow(population))\r\n  validData = as.logical(validData & (population > 1) & (occurrence >= 0)  & (occurrence <= population ))\r\n}\r\n\r\nif(validToPlot && (sum(validData) < minPoints)) # not enough data samples\r\n{\r\n  validToPlot = FALSE\r\n  pbiWarning1 = \"Not enough data samples\"\r\n  pbiWarning1 = cutStr2Show(pbiWarning1, strCex = sizeWarn/6, partAvailable = 0.9)\r\n  pbiWarning2 = \"for funnel plot\"\r\n  pbiWarning2 = cutStr2Show(pbiWarning2, strCex = sizeWarn/6, partAvailable = 0.9)\r\n  pbiWarning<-paste(pbiWarning1, \"<br>\", pbiWarning2, sep=\"\")\r\n}\r\n\r\nif(validToPlot ) # check packages\r\n{\r\n  si = sessionInfo()\r\n  namesPackages =  c(names(si$otherPkgs), names(si$basePkgs),names(si$loadedOnly))\r\n  checkPackages = c(\"XML\",\"plotly\",\"ggplot2\",\"htmlwidgets\",\"scales\")\r\n  flagAllPackages = prod(checkPackages %in% namesPackages)\r\n\r\n  if(!flagAllPackages) \r\n    warning(\"*** Some of the packages are missing ! ***\")\r\n}\r\n\r\n############# Main code #####################\r\n\r\nif(validToPlot)\r\n{\r\n  if(!exists(\"tooltips\"))\r\n  {\r\n    dataset = cbind(population,occurrence)\r\n  }else{\r\n    dataset = cbind(population,occurrence,tooltips)\r\n  }\r\n  \r\n  dataset = dataset[validData,]# keep only valid\r\n  namesDS = names(dataset)\r\n  \r\n  countValue = dataset[,1]\r\n  p = dataset[,2]/dataset[,1]\r\n  p.se <- sqrt((p*(1-p)) / (countValue))\r\n  df <- data.frame(p, countValue, p.se)\r\n  \r\n  ## common effect (fixed effect model)\r\n  p.fem <- weighted.mean(p[p.se>0], 1/p.se[p.se>0]^2)\r\n  \r\n  ## lower and upper limits, based on FEM estimator\r\n  zLow = qnorm(conf1)\r\n  zUp = qnorm(conf2)\r\n  \r\n  \r\n  mult = 1\r\n  entryWordLabelY = \"Ratio of \"\r\n  if(axisXisPercentage)\r\n  {\r\n    mult = 100\r\n    entryWordLabelY = \"Percentage of \"\r\n  }\r\n  \r\n  number.seq <- seq(min(countValue), max(countValue), 1000)\r\n  number.llconf1 <- (p.fem - zLow * sqrt((p.fem*(1-p.fem)) / (number.seq)))*mult\r\n  number.ulconf1 <- (p.fem + zLow * sqrt((p.fem*(1-p.fem)) / (number.seq)))*mult\r\n  number.llconf2 <- (p.fem - zUp * sqrt((p.fem*(1-p.fem)) / (number.seq)))*mult\r\n  number.ulconf2 <- (p.fem + zUp * sqrt((p.fem*(1-p.fem)) / (number.seq)))*mult\r\n  \r\n  yAxis = p*mult\r\n  p.fem = p.fem*mult\r\n  \r\n  dfCI <- data.frame(number.llconf1, number.ulconf1, number.llconf2, number.ulconf2, number.seq, p.fem)\r\n  \r\n  #tweak the limits of the y-axis\r\n  limsY = NiceLimitsAxis(axisData = yAxis, baseline = p.fem)\r\n  \r\n  xLabText = cutStr2Show( namesDS[1], strCex = sizeLabel/6, isH = TRUE, partAvailable = 0.85)\r\n  yLabText = cutStr2Show( paste(entryWordLabelY, namesDS[2], sep =\"\"), strCex = sizeLabel/6, isH = FALSE, partAvailable = 0.85)\r\n  \r\n  ## draw plot\r\n  if(sparsify)\r\n    drawPoints = SparsifyScatter(dataset)# remove points from dense regions\r\n  else\r\n    drawPoints = SparsifyScatter(dataset,minMaxPoints = c(Inf,Inf))\r\n  \r\n  fp <- ggplot(aes(x = countValue[drawPoints], y = yAxis[drawPoints]), data = df[drawPoints,]) \r\n  fp <- fp + geom_point(shape = 19, colour = alpha(pointsCol,transparency), size = pointCex*2 ) \r\n  \r\n  fp <- fp + geom_line(aes(x = number.seq, y = number.llconf1),linetype = 1, colour = \"green\",data = dfCI) \r\n  fp <- fp + geom_line(aes(x = number.seq, y = number.ulconf1),linetype = 1, colour = \"green\", data = dfCI) \r\n  \r\n  fp <- fp + geom_line(aes(x = number.seq, y = number.llconf2),linetype = 2, colour = \"red\",data = dfCI) \r\n  fp <- fp + geom_line(aes(x = number.seq, y = number.ulconf2), linetype = 2, colour = \"red\",data = dfCI) \r\n  \r\n  fp <- fp + geom_hline(aes(yintercept = p.fem), data = dfCI, colour = lineColor, linetype = 4)\r\n  \r\n  if(scaleYformat %in% c(\"none\"))\r\n    fp <- fp + scale_y_continuous(limits =limsY)\r\n  \r\n  if(scaleYformat %in% c(\"comma\"))\r\n    fp <- fp + scale_y_continuous(limits =limsY, labels = comma)\r\n  \r\n  if(scaleYformat %in% c(\"scientific\"))\r\n    fp <- fp + scale_y_continuous(limits =limsY, labels = scientific)\r\n  \r\n  if(scaleXformat %in% c(\"comma\"))\r\n    fp <- fp + scale_x_continuous(labels = comma)\r\n  \r\n  if(scaleXformat %in% c(\"dollar\"))\r\n    fp <- fp + scale_x_continuous(labels = dollar)\r\n  \r\n  if(scaleXformat %in% c(\"scientific\"))\r\n    fp <- fp + scale_x_continuous(labels = scientific)\r\n  \r\n  fp <- fp + xlab(xLabText) + ylab(yLabText) + theme_bw()\r\n  \r\n  if(verticalPlot)\r\n    fp <- fp +  coord_flip()\r\n  \r\n}else{# empty plot \r\n  fp <- ggplot()\r\n}\r\n\r\n#add warning as title\r\nfp = fp + labs (title = pbiWarning, caption = NULL) + theme_bw() + \r\n  theme(plot.title  = element_text(hjust = 0.5, size = sizeWarn), \r\n        axis.title=element_text(size =  sizeLabel, colour = colLabel),\r\n        axis.text=element_text(size =  sizeTicks),\r\n        panel.border = element_blank(), axis.line = element_line())\r\n\r\nif(!validToPlot) # remove box from empty plot \r\n  fp = fp + theme(axis.line = element_blank())\r\n\r\n\r\n############# Create and save widget ###############\r\n\r\np = ggplotly(fp);\r\n\r\ndisabledButtonsList <- list('toImage', 'sendDataToCloud', 'zoom2d', 'pan', 'pan2d', 'select2d', 'lasso2d', 'hoverClosestCartesian', 'hoverCompareCartesian')\r\np$x$config$modeBarButtonsToRemove = disabledButtonsList\r\n\r\np <- config(p, staticPlot = FALSE, editable = FALSE, sendData = FALSE, showLink = FALSE,\r\n            displaylogo = FALSE,  collaborate = FALSE, cloud=FALSE)\r\n\r\nif(validToPlot)\r\n{\r\n  layerScatter = 1 # first layer is scatter \r\n  ntt = generateNiceTooltips(dataset[drawPoints,])\r\n  #tooltips on scatter\r\n  p$x$data[[layerScatter]]$text = ntt\r\n  \r\n  #tooltips on lines\r\n  p$x$data[[2]]$text = paste(as.character(conf1*100),\"% limits (l)\",sep =\"\")\r\n  p$x$data[[3]]$text = paste(as.character(conf1*100),\"% limits (u)\",sep =\"\")\r\n  p$x$data[[4]]$text = paste(as.character(conf2*100),\"% limits (l)\",sep =\"\")\r\n  p$x$data[[5]]$text = paste(as.character(conf2*100),\"% limits (u)\",sep =\"\")\r\n  p$x$data[[6]]$text = paste(\"baseline \", as.character(round(p.fem,4)), sep =\"\")\r\n  \r\n}\r\n\r\ninternalSaveWidget(p, 'out.html')\r\n\r\n####################################################\r\n\r\n#DEBUG in RStudio\r\n# if(Sys.getenv(\"RSTUDIO\")!=\"\")\r\n#   print(p)\r\n"}}}],"objects":{"rcv_script":{"properties":{"provider":{"type":{"text":true}},"source":{"type":{"scripting":{"source":true}}}}},"settings_funnel_params":{"displayName":" Settings","description":"Funnel plot settings","properties":{"lineColor":{"displayName":"Baseline color","type":{"fill":{"solid":{"color":true}}}},"conf1":{"displayName":"Confidence level #1","description":"Confidence level #1","type":{"enumeration":[{"displayName":"0.75","value":"0.75"},{"displayName":"0.85","value":"0.85"},{"displayName":"0.9","value":"0.9"},{"displayName":"0.95","value":"0.95"},{"displayName":"0.975","value":"0.975"},{"displayName":"0.99","value":"0.99"},{"displayName":"0.995","value":"0.995"},{"displayName":"0.999","value":"0.999"}]}},"conf2":{"displayName":"Confidence level #2","description":"Confidence level #2","type":{"enumeration":[{"displayName":"0.75","value":"0.75"},{"displayName":"0.85","value":"0.85"},{"displayName":"0.9","value":"0.9"},{"displayName":"0.95","value":"0.95"},{"displayName":"0.975","value":"0.975"},{"displayName":"0.99","value":"0.99"},{"displayName":"0.995","value":"0.995"},{"displayName":"0.999","value":"0.999"}]}}}},"settings_scatter_params":{"displayName":"Scatter","description":"Scatter settings","properties":{"pointColor":{"displayName":"Point color","description":"Point color","type":{"fill":{"solid":{"color":true}}}},"weight":{"displayName":"Point size","type":{"numeric":true}},"percentile":{"displayName":"Opacity","description":"Point Opacity","type":{"numeric":true}},"sparsify":{"displayName":"Sparsify","description":"Sparsify dense regions of the scatter plot. Recommended for overcoming overdraw and memory issues. ","type":{"bool":true}}}},"settings_axes_params":{"displayName":"Axes","description":"Axes and labels settings","properties":{"colLabel":{"displayName":"Labels color","description":"Labels color","type":{"fill":{"solid":{"color":true}}}},"textSize":{"displayName":"Labels size","type":{"numeric":true}},"axisXisPercentage":{"displayName":"Percentage","description":"Show percentage rather than ratio","type":{"bool":true}},"scaleXformat":{"displayName":"Scale X format","description":"Scale X format","type":{"enumeration":[{"displayName":"none","value":"none"},{"displayName":"comma","value":"comma"},{"displayName":"scientific","value":"scientific"},{"displayName":"dollar","value":"dollar"}]}},"scaleYformat":{"displayName":"Scale Y format","description":"Scale Y format","type":{"enumeration":[{"displayName":"none","value":"none"},{"displayName":"comma","value":"comma"},{"displayName":"scientific","value":"scientific"}]}},"sizeTicks":{"displayName":"Size ticks","description":"Size ticks","type":{"enumeration":[{"displayName":"4","value":"4"},{"displayName":"6","value":"6"},{"displayName":"8","value":"8"},{"displayName":"10","value":"10"},{"displayName":"12","value":"12"},{"displayName":"14","value":"14"},{"displayName":"16","value":"16"},{"displayName":"18","value":"18"},{"displayName":"20","value":"20"}]}}}}},"suppressDefaultTitle":true},"dependencies":{"cranPackages":[{"name":"scales","displayName":"scales: Scale Functions for Visualization","url":"https://cran.r-project.org/web/packages/scales/index.html"},{"name":"reshape","displayName":"reshape:  lets you flexibly restructure and aggregate data","url":"https://cran.r-project.org/web/packages/reshape/index.html"},{"name":"ggplot2","displayName":"ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics","url":"https://cran.r-project.org/web/packages/ggplot2/index.html"},{"name":"htmlwidgets","displayName":"htmlwidgets: HTML Widgets for R","url":"https://cran.r-project.org/web/packages/htmlwidgets/index.html"},{"name":"XML","displayName":"XML: Tools for Parsing and Generating XML Within R and S-Plus","url":"https://cran.r-project.org/web/packages/XML/index.html"},{"name":"plotly","displayName":"plotly: Create Interactive Web Graphics via plotly","url":"https://cran.r-project.org/web/packages/plotly/index.html"}]},"stringResources":{},"content":{"js":"var powerbi;!function(e){!function(e){!function(e){!function(e){function t(){r=0}function s(){return 0===r}function i(e,t){var s=[];if(e&&e.hasChildNodes()){for(var i=e.children,a=0;a<i.length;a++){var r=void 0;r=\"script\"===i.item(a).nodeName.toLowerCase()?n(i.item(a)):i.item(a).cloneNode(!0),t.appendChild(r),s.push(r)}return s}}function n(e){for(var t=document.createElement(\"script\"),s=e.attributes,i=0;i<s.length;i++)t.setAttribute(s[i].name,s[i].textContent),\"src\"===s[i].name.toLowerCase()&&(r++,t.onload=function(){r--});return t.innerHTML=e.innerHTML,t}function a(){var e=window.setInterval(function(){s()&&(window.clearInterval(e),window.hasOwnProperty(\"HTMLWidgets\")&&window.HTMLWidgets.staticRender&&window.HTMLWidgets.staticRender())},100)}var r=0;e.ResetInjector=t,e.injectorReady=s,e.ParseElement=i,e.RunHTMLWidgetRenderer=a}(e.RHTML_FUNNEL_978302916642||(e.RHTML_FUNNEL_978302916642={}))}(e.visual||(e.visual={}))}(e.extensibility||(e.extensibility={}))}(powerbi||(powerbi={}));var powerbi;!function(e){!function(e){!function(e){!function(e){function t(e,t,s,i){if(e){var n=e[t];if(n){var a=n[s];if(void 0!==a)return a}}return i}function s(e,t,s,i,n){var a=e.objects;if(a){var r=a[t];if(r){var o=r[s];if(o){var l=o[i];if(void 0!==l)return l}}}return n}function i(e,t,s){return e<t?t:e>s?s:e}e.getValue=t,e.getCategoricalObjectValue=s,e.inMinMax=i}(e.RHTML_FUNNEL_978302916642||(e.RHTML_FUNNEL_978302916642={}))}(e.visual||(e.visual={}))}(e.extensibility||(e.extensibility={}))}(powerbi||(powerbi={}));var powerbi;!function(e){!function(t){!function(t){!function(t){var s=[e.VisualUpdateType.Resize,e.VisualUpdateType.ResizeEnd,e.VisualUpdateType.Resize+e.VisualUpdateType.ResizeEnd],i=function(){function e(e){e&&e.element&&(this.rootElement=e.element),this.headNodes=[],this.bodyNodes=[],this.settings_funnel={lineColor:\"blue\",conf1:\"0.95\",conf2:\"0.999\"},this.settings_scatter={pointColor:\"orange\",weight:10,percentile:40,sparsify:!0},this.settings_axes={colLabel:\"gray\",textSize:12,scaleXformat:\"comma\",scaleYformat:\"none\",sizeTicks:\"8\",axisXisPercentage:!0}}return e.prototype.update=function(e){if(e&&e.type&&e.viewport){var t=e.dataViews;if(t&&0!==t.length){var i=t[0];if(i&&i.metadata){this.updateObjects(i.metadata.objects);var n=null;i.scriptResult&&i.scriptResult.payloadBase64&&(n=i.scriptResult.payloadBase64),-1===s.indexOf(e.type)&&n&&this.injectCodeFromPayload(n),this.onResizing(e.viewport)}}}},e.prototype.onResizing=function(e){},e.prototype.injectCodeFromPayload=function(e){if(t.ResetInjector(),e){var s=document.createElement(\"html\");try{s.innerHTML=window.atob(e)}catch(e){return}if(0===this.headNodes.length){for(;this.headNodes.length>0;){var i=this.headNodes.pop();document.head.removeChild(i)}var n=s.getElementsByTagName(\"head\");if(n&&n.length>0){var a=n[0];this.headNodes=t.ParseElement(a,document.head)}}for(;this.bodyNodes.length>0;){var i=this.bodyNodes.pop();this.rootElement.removeChild(i)}var r=s.getElementsByTagName(\"body\");if(r&&r.length>0){var o=r[0];this.bodyNodes=t.ParseElement(o,this.rootElement)}t.RunHTMLWidgetRenderer()}},e.prototype.updateObjects=function(e){this.settings_funnel={lineColor:t.getValue(e,\"settings_funnel_params\",\"lineColor\",\"blue\"),conf1:t.getValue(e,\"settings_funnel_params\",\"conf1\",\"0.95\"),conf2:t.getValue(e,\"settings_funnel_params\",\"conf2\",\"0.999\")},this.settings_scatter={pointColor:t.getValue(e,\"settings_scatter_params\",\"pointColor\",\"orange\"),weight:t.getValue(e,\"settings_scatter_params\",\"weight\",10),percentile:t.getValue(e,\"settings_scatter_params\",\"percentile\",40),sparsify:t.getValue(e,\"settings_scatter_params\",\"sparsify\",!0)},this.settings_axes={colLabel:t.getValue(e,\"settings_axes_params\",\"colLabel\",\"gray\"),textSize:t.getValue(e,\"settings_axes_params\",\"textSize\",12),scaleXformat:t.getValue(e,\"settings_axes_params\",\"scaleXformat\",\"comma\"),scaleYformat:t.getValue(e,\"settings_axes_params\",\"scaleYformat\",\"none\"),sizeTicks:t.getValue(e,\"settings_axes_params\",\"sizeTicks\",\"8\"),axisXisPercentage:t.getValue(e,\"settings_axes_params\",\"axisXisPercentage\",!0)}},e.prototype.enumerateObjectInstances=function(e){var s=e.objectName,i=[];switch(s){case\"settings_funnel_params\":i.push({objectName:s,properties:{lineColor:this.settings_funnel.lineColor,conf1:this.settings_funnel.conf1,conf2:this.settings_funnel.conf2},selector:null});break;case\"settings_scatter_params\":i.push({objectName:s,properties:{pointColor:this.settings_scatter.pointColor,weight:t.inMinMax(this.settings_scatter.weight,1,50),percentile:this.settings_scatter.percentile,sparsify:this.settings_scatter.sparsify},selector:null});break;case\"settings_axes_params\":i.push({objectName:s,properties:{colLabel:this.settings_axes.colLabel,textSize:this.settings_axes.textSize,sizeTicks:this.settings_axes.sizeTicks,scaleXformat:this.settings_axes.scaleXformat,axisXisPercentage:this.settings_axes.axisXisPercentage,scaleYformat:this.settings_axes.scaleYformat},selector:null})}return i},e}();t.Visual=i}(t.RHTML_FUNNEL_978302916642||(t.RHTML_FUNNEL_978302916642={}))}(t.visual||(t.visual={}))}(e.extensibility||(e.extensibility={}))}(powerbi||(powerbi={}));var powerbi;!function(e){!function(t){!function(t){t.RHTML_FUNNEL_978302916642={name:\"RHTML_FUNNEL_978302916642\",displayName:\"Funnel plot\",class:\"Visual\",version:\"1.0.0\",apiVersion:\"1.6.0\",create:function(t){return new e.extensibility.visual.RHTML_FUNNEL_978302916642.Visual(t)},custom:!0}}(t.plugins||(t.plugins={}))}(e.visuals||(e.visuals={}))}(powerbi||(powerbi={}));","css":".visual-RHTML_FUNNEL_978302916642 .rcv_autoScaleImageContainer{position:relative}.visual-RHTML_FUNNEL_978302916642 .rcv_autoScaleImageContainer .rcv_autoScaleImage{max-width:100%;max-height:100%;position:absolute;top:50%;left:50%;transform:translateY(-50%) translateX(-50%);-webkit-transform:translateY(-50%) translateX(-50%)}","iconBase64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAASbgAAEm4BzAbEXgAAABl0RVh0U29mdHdhcmUAcGFpbnQubmV0IDQuMC4xNkRpr/UAAAHsSURBVDhPrZRBaBNBFIYnLSpVa6W3Cp4MuQniWZBWhZa2s4nJUqQ9aJKZSsAWaVoaQXcDKvasFCMKQbzEpjmIHgTJyWvwoKAHxVMpPXj0+sZ/xmeIeEl3/eEn897b+ebtzE5EtVq9EIbhsoBoUWaM7w/acWQBdiUIgk07tjCjvTqp9ClXjCIGPuZQGCUfkPI+k8qMcWp/YuATDoUJggFSsga/oVxuyMZc6k8MfMphV0b7I+i0DO+Qls+xQJ5u5oawHVMYjxs9cw4+TMV0itTMWVP0zrjFLRB+xpy/ZPcUgPOA3jZartNV7yTgHxB/AfQbFWaT+G3Au/CeKflH/3RYZ0Z8WeCt8G5DPKQTsW1MwgHn773YEY+Mie0NGhZ3AKyE919hhVRsB2bAAuewhy95B+ILV8/Ha29x+I9woqdxgks43VUq5EZJe++R6yD38XfN28T4K/ydFi4dscAsOmzy/K7oxuQh3G2FCT/x8FtSsxWX0+kF5LLISbPsHXffn5IXEY+7/wHALqPDbeY4YcIK3AbgGOXlMKf7EzrMANriUODVrsE/7NfPqf2pF2iESKD1d3Q9M+GKUdQLtN3Z++kKUWWB2MMmOpuG9+y+cSmaAPTR4afX5VKntbbUBrwS1eActKechPX/cK1WO/ALf9ymze4BomcAAAAASUVORK5CYII="}}